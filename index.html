<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>计算器 | 91vvic</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      padding: 24px;
    }

    .wrapper {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }

    .calculator {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 24px;
      padding: 24px;
      width: 340px;
      flex-shrink: 0;
      box-shadow:
        0 25px 50px rgba(0, 0, 0, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .display {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 16px;
      padding: 20px 24px 16px;
      margin-bottom: 20px;
      min-height: 110px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: flex-end;
      overflow: hidden;
    }

    .expression {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.4);
      min-height: 20px;
      word-break: break-all;
      text-align: right;
      margin-bottom: 8px;
    }

    .result {
      font-size: 42px;
      font-weight: 300;
      color: #ffffff;
      letter-spacing: -1px;
      word-break: break-all;
      text-align: right;
      transition: font-size 0.1s;
    }

    .result.small { font-size: 28px; }

    .buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    button {
      height: 64px;
      border: none;
      border-radius: 14px;
      font-size: 18px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      outline: none;
      position: relative;
      overflow: hidden;
    }

    button::after {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0);
      transition: background 0.15s;
    }

    button:active::after { background: rgba(255, 255, 255, 0.15); }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0) scale(0.96); }

    .btn-number {
      background: rgba(255, 255, 255, 0.08);
      color: #ffffff;
      border: 1px solid rgba(255, 255, 255, 0.06);
    }
    .btn-number:hover { background: rgba(255, 255, 255, 0.14); }

    .btn-operator {
      background: rgba(99, 179, 237, 0.2);
      color: #63b3ed;
      border: 1px solid rgba(99, 179, 237, 0.2);
    }
    .btn-operator:hover { background: rgba(99, 179, 237, 0.32); }

    .btn-equals {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
      border: none;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    .btn-equals:hover { box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }

    .btn-clear {
      background: rgba(252, 129, 129, 0.15);
      color: #fc8181;
      border: 1px solid rgba(252, 129, 129, 0.2);
    }
    .btn-clear:hover { background: rgba(252, 129, 129, 0.28); }

    .btn-function {
      background: rgba(255, 255, 255, 0.06);
      color: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.06);
      font-size: 15px;
    }
    .btn-function:hover { background: rgba(255, 255, 255, 0.12); }

    .btn-zero { grid-column: span 2; }

    /* 历史记录面板 */
    .history-panel {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 24px;
      padding: 20px;
      width: 240px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      max-height: 520px;
      display: flex;
      flex-direction: column;
    }

    .history-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .history-title {
      font-size: 13px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.5);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .history-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #68d391;
      box-shadow: 0 0 6px #68d391;
      flex-shrink: 0;
    }

    .history-status.connecting {
      background: #f6ad55;
      box-shadow: 0 0 6px #f6ad55;
      animation: pulse 1s infinite;
    }

    .history-status.error {
      background: #fc8181;
      box-shadow: 0 0 6px #fc8181;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .history-list {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .history-list::-webkit-scrollbar {
      width: 4px;
    }
    .history-list::-webkit-scrollbar-track {
      background: transparent;
    }
    .history-list::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.15);
      border-radius: 2px;
    }

    .history-item {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 12px;
      padding: 10px 12px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(10px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .history-item-expr {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.35);
      margin-bottom: 3px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .history-item-result {
      font-size: 18px;
      font-weight: 400;
      color: #ffffff;
    }

    .history-item-time {
      font-size: 10px;
      color: rgba(255, 255, 255, 0.2);
      margin-top: 4px;
    }

    .history-empty {
      color: rgba(255, 255, 255, 0.2);
      font-size: 13px;
      text-align: center;
      margin-top: 40px;
    }

    .saving-indicator {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: rgba(102, 126, 234, 0.9);
      color: white;
      font-size: 13px;
      padding: 8px 16px;
      border-radius: 20px;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }

    .saving-indicator.show { opacity: 1; }

    @media (max-width: 640px) {
      .wrapper { flex-direction: column; align-items: center; }
      .history-panel { width: 340px; max-height: 200px; }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="calculator">
      <div class="display">
        <div class="expression" id="expression"></div>
        <div class="result" id="result">0</div>
      </div>
      <div class="buttons">
        <button class="btn-clear" onclick="clearAll()">AC</button>
        <button class="btn-function" onclick="toggleSign()">+/-</button>
        <button class="btn-function" onclick="percentage()">%</button>
        <button class="btn-operator" onclick="inputOperator('÷')">÷</button>

        <button class="btn-number" onclick="inputNumber('7')">7</button>
        <button class="btn-number" onclick="inputNumber('8')">8</button>
        <button class="btn-number" onclick="inputNumber('9')">9</button>
        <button class="btn-operator" onclick="inputOperator('×')">×</button>

        <button class="btn-number" onclick="inputNumber('4')">4</button>
        <button class="btn-number" onclick="inputNumber('5')">5</button>
        <button class="btn-number" onclick="inputNumber('6')">6</button>
        <button class="btn-operator" onclick="inputOperator('-')">−</button>

        <button class="btn-number" onclick="inputNumber('1')">1</button>
        <button class="btn-number" onclick="inputNumber('2')">2</button>
        <button class="btn-number" onclick="inputNumber('3')">3</button>
        <button class="btn-operator" onclick="inputOperator('+')">+</button>

        <button class="btn-number btn-zero" onclick="inputNumber('0')">0</button>
        <button class="btn-number" onclick="inputDecimal()">.</button>
        <button class="btn-equals" onclick="calculate()">=</button>
      </div>
    </div>

    <div class="history-panel">
      <div class="history-header">
        <span class="history-title">计算历史</span>
        <div class="history-status connecting" id="statusDot"></div>
      </div>
      <div class="history-list" id="historyList">
        <div class="history-empty">暂无记录</div>
      </div>
    </div>
  </div>

  <div class="saving-indicator" id="savingIndicator">已保存 ✓</div>

  <!-- 计算器核心逻辑：独立脚本，不依赖任何外部库 -->
  <script>
    let currentInput = '0';
    let previousInput = '';
    let operator = null;
    let shouldResetInput = false;
    let expressionStr = '';

    const resultEl = document.getElementById('result');
    const expressionEl = document.getElementById('expression');

    function updateDisplay() {
      resultEl.textContent = currentInput;
      resultEl.className = 'result' + (currentInput.length > 9 ? ' small' : '');
      expressionEl.textContent = expressionStr;
    }

    function inputNumber(num) {
      if (shouldResetInput) {
        currentInput = num;
        shouldResetInput = false;
      } else {
        currentInput = currentInput === '0' ? num : currentInput + num;
      }
      updateDisplay();
    }

    function inputDecimal() {
      if (shouldResetInput) {
        currentInput = '0.';
        shouldResetInput = false;
      } else if (!currentInput.includes('.')) {
        currentInput += '.';
      }
      updateDisplay();
    }

    function inputOperator(op) {
      if (operator && !shouldResetInput) calculate(true);
      previousInput = currentInput;
      operator = op;
      expressionStr = currentInput + ' ' + op;
      shouldResetInput = true;
      updateDisplay();
    }

    function calculate(intermediate = false) {
      if (!operator || shouldResetInput) return;

      const prev = parseFloat(previousInput);
      const curr = parseFloat(currentInput);
      let result;

      switch (operator) {
        case '+': result = prev + curr; break;
        case '−': result = prev - curr; break;
        case '×': result = prev * curr; break;
        case '÷': result = curr !== 0 ? prev / curr : 'Error'; break;
        default: return;
      }

      const expr = previousInput + ' ' + operator + ' ' + currentInput;
      const resultStr = result === 'Error'
        ? 'Error'
        : parseFloat(result.toPrecision(12)).toString();

      if (!intermediate) {
        expressionStr = expr + ' =';
        if (result !== 'Error' && typeof window.saveCalculation === 'function') {
          window.saveCalculation(expr, resultStr);
        }
        operator = null;
      }

      currentInput = resultStr;
      shouldResetInput = true;
      updateDisplay();
    }

    function clearAll() {
      currentInput = '0';
      previousInput = '';
      operator = null;
      shouldResetInput = false;
      expressionStr = '';
      updateDisplay();
    }

    function toggleSign() {
      if (currentInput !== '0' && currentInput !== 'Error') {
        currentInput = currentInput.startsWith('-')
          ? currentInput.slice(1)
          : '-' + currentInput;
        updateDisplay();
      }
    }

    function percentage() {
      if (currentInput !== 'Error') {
        currentInput = (parseFloat(currentInput) / 100).toString();
        updateDisplay();
      }
    }

    document.addEventListener('keydown', (e) => {
      if (e.key >= '0' && e.key <= '9') inputNumber(e.key);
      else if (e.key === '.') inputDecimal();
      else if (e.key === '+') inputOperator('+');
      else if (e.key === '-') inputOperator('−');
      else if (e.key === '*') inputOperator('×');
      else if (e.key === '/') { e.preventDefault(); inputOperator('÷'); }
      else if (e.key === 'Enter' || e.key === '=') calculate();
      else if (e.key === 'Escape') clearAll();
      else if (e.key === 'Backspace') {
        if (!shouldResetInput && currentInput.length > 1) {
          currentInput = currentInput.slice(0, -1);
        } else {
          currentInput = '0';
        }
        updateDisplay();
      }
    });
  </script>

  <!-- Supabase 历史记录：独立脚本，即使加载失败也不影响计算器 -->
  <script>
    (function () {
      const SUPABASE_URL = 'https://cdlfsbliwtwmycyzcluu.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNkbGZzYmxpd3R3bXljeXpjbHV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwOTEyMTcsImV4cCI6MjA4NzY2NzIxN30.9A0dYnOv_Fk3xrq_J6zWFmKzPxDCpdyAfBQ7walACQI';

      const statusDot = document.getElementById('statusDot');
      const historyList = document.getElementById('historyList');
      const savingIndicator = document.getElementById('savingIndicator');

      let db;
      try {
        db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      } catch (e) {
        statusDot.className = 'history-status error';
        return;
      }

      async function loadHistory() {
        try {
          const { data, error } = await db
            .from('calculations')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(20);

          if (error) { statusDot.className = 'history-status error'; return; }
          statusDot.className = 'history-status';
          renderHistory(data);
        } catch (e) {
          statusDot.className = 'history-status error';
        }
      }

      function renderHistory(records) {
        if (!records || records.length === 0) {
          historyList.innerHTML = '<div class="history-empty">暂无记录</div>';
          return;
        }
        historyList.innerHTML = records.map(r => {
          const time = new Date(r.created_at).toLocaleTimeString('zh-CN', {
            hour: '2-digit', minute: '2-digit', second: '2-digit'
          });
          return `
            <div class="history-item">
              <div class="history-item-expr">${r.expression}</div>
              <div class="history-item-result">${r.result}</div>
              <div class="history-item-time">${time}</div>
            </div>`;
        }).join('');
      }

      // 暴露给计算器调用的保存函数
      window.saveCalculation = async function (expression, result) {
        if (!db) return;
        try {
          const { error } = await db.from('calculations').insert({ expression, result });
          if (!error) {
            savingIndicator.classList.add('show');
            setTimeout(() => savingIndicator.classList.remove('show'), 1500);
            loadHistory();
          }
        } catch (e) {}
      };

      // 实时订阅
      try {
        db.channel('calculations')
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'calculations' }, loadHistory)
          .subscribe();
      } catch (e) {}

      loadHistory();
    })();
  </script>
</body>
</html>
